APPROACH: $darg_tent FROM $barracks

// ---
ROOM: $darg_tent

POS: 33, 24
MAP_NAME: Darg's tent

FIRST_DESCRIPTION:
Tent outside, at the top of the elevator structure. Overlooking the bay. Some important orc must be stationed here.

DESCRIPTION: $NONE

AFTER_MONSTERS_CLEARED:
I look around and there are no more orcs. They probably didn't consider it necessary to post guards around this remote place.

[[CODE]]
c.markHappened(evKilledDarg);
[[ENDCODE]]

[[CODE]]
// Use the ink defined in darg_tent/darg_head_talk.
w.pushSituation(InkSituation.initialized(
    w.randomInt(),
    "darg_head_talk_ink_ink",
));
[[ENDCODE]]


// ---
ROOM: $darg_tent_after_darg_arrived
VARIANT_OF: $darg_tent

// This happens ~10 minutes after the player first visited crowdsource.
RULE:
c.hasHappened(evDargLeftCrowdsource)

FIRST_DESCRIPTION:
Tent outside, at the top of the elevator structure. Overlooking the bay. Darg, the leader of the orcs, is here.

![Illustration of Darg, a huge orc with a weapon that resembles a battle axe.](darg.png)

VARIANT_UPDATE_DESCRIPTION:
Darg, the leader of the orcs, is here.

![Illustration of Darg, a huge orc with a weapon that resembles a battle axe.](darg.png)


// ---
ROOM: $darg_tent_after_darg_killed
VARIANT_OF: $darg_tent

RULE:
c.hasHappened(evKilledDarg)
&&
!c.hasHappened(evDargLeftCrowdsource)

FIRST_DESCRIPTION:
Tent outside, at the top of the elevator structure. Overlooking the bay. Some important orc must be stationed here.

VARIANT_UPDATE_DESCRIPTION:
Darg won't be needing this tent anymore.


// ---
ACTION: $darg_tent_attack
FOR_LOCATION: $darg_tent
PREREQUISITES:
c.hasHappened(evDargLeftCrowdsource)
&&
!c.hasHappened(evKilledDarg)

COMMAND: Darg >> Attack

COMPLETE_SUCCESS_DESCRIPTION:
[[CODE]]
// This is copy-pasted from SlayMonstersAction. Ideally, we could have an "optional fight" bit on rooms that would make this automatically.
// Same code is in crowdsource.egb.txt.

final situation = w.currentSituation as RoomRoamingSituation;
Room room = sim.getRoomParent(sim.getRoomByName(situation.currentRoomName));

WorldState built = w.build();
var friends = built.actors
    .where((other) =>
        other.isAnimatedAndActive &&
        other.team.isFriendWith(a.team) &&
        other.currentRoomName == room.name)
    .toList(growable: false);

var fightSituation = generateDargTentFight(c, situation, friends);
assert(() {
  WorldState rebuilt = w.build();
  return fightSituation.enemyTeamIds
      .every((id) => rebuilt.actors.any((a) => a.id == id));
}(),
    "FightGenerator in $room didn't add its monsters to the world's "
    "actors. Add a line like `w.actors.addAll(monsters)` to the "
    "generator. At least one of these actors is missing: "
    "${fightSituation.enemyTeamIds}");

// Move enemy combatants to the room (fightGenerator cannot know which
// room it will be, so their currentRoomName is `null`).
for (final enemyId in fightSituation.enemyTeamIds) {
  w.updateActorById(enemyId, (b) => b.currentRoomName = room.name);
}

// _assignRecoveringUntil(
//    originalWorld.time, w, fightSituation.getActors(sim, w.build()));

w.pushSituation(fightSituation);
[[ENDCODE]]


NOTES:
- This is empty unless you've heard Darg talk in the source.

- This is where you finally confront the Akxe orc (named captain - Darg).
- Darg's head talks after you kill him. Big O is taunting you.
- Darg's Akxe is the key to the antechamber.
- You might see him before, but shouldn't be able to kill him.
